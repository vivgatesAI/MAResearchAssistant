/**
 * Output Generator - Creates reports, papers, slides for Medical Affairs
 */

const fs = require("fs");
const path = require("path");

class OutputGenerator {
  constructor(outputDir) {
    this.outputDir = outputDir || "./output";
    this.ensureDir();
  }

  ensureDir() {
    if (!fs.existsSync(this.outputDir)) {
      fs.mkdirSync(this.outputDir, { recursive: true });
    }
  }

  /**
   * Generate timestamped filename
   */
  getFilename(baseName, extension) {
    var timestamp = new Date().toISOString().replace(/[:.]/g, "-").substring(0, 19);
    return baseName + "-" + timestamp + "." + extension;
  }

  /**
   * Generate full research report (Markdown)
   */
  async generateReport(query, articles, summary, taskType) {
    var filename = this.getFilename("MA-Report-" + this.slugify(query), "md");
    var filepath = path.join(this.outputDir, filename);

    var content = "# Medical Affairs Research Report\n\n";
    content += "**Topic:** " + query + "\n";
    content += "**Date:** " + new Date().toISOString().substring(0, 10) + "\n";
    content += "**Task Type:** " + taskType + "\n";
    content += "**Articles Analyzed:** " + articles.length + "\n\n";

    content += "---\n\n";
    content += "## Executive Summary\n\n";
    content += summary + "\n\n";

    content += "---\n\n";
    content += "## Key Publications\n\n";

    for (var i = 0; i < articles.length; i++) {
      var a = articles[i];
      content += "### " + (i+1) + ". " + (a.title || "Untitled") + "\n\n";
      content += "- **PMID:** " + a.pmid + "\n";
      if (a.authors && a.authors.length > 0) {
        content += "- **Authors:** " + a.authors.join(", ") + "\n";
      }
      if (a.journal) {
        content += "- **Journal:** " + a.journal + "\n";
      }
      if (a.pubDate) {
        content += "- **Published:** " + a.pubDate + "\n";
      }
      if (a.abstract) {
        content += "\n**Abstract:**\n" + a.abstract + "\n";
      }
      content += "\n";
    }

    content += "---\n\n";
    content += "*Generated by MA Research Assistant (Venice AI + PubMed)*\n";

    fs.writeFileSync(filepath, content, "utf8");
    return filepath;
  }

  /**
   * Generate full research paper
   */
  async generatePaper(query, articles, sections) {
    var filename = this.getFilename("MA-Paper-" + this.slugify(query), "md");
    var filepath = path.join(this.outputDir, filename);

    var content = "# Literature Review\n\n";
    content += "**Title:** " + query + "\n";
    content += "**Date:** " + new Date().toISOString().substring(0, 10) + "\n\n";

    content += "---\n\n## Abstract\n\n";
    content += sections.abstract || "(Generated from Venice AI)\n\n";

    content += "---\n\n## Introduction\n\n";
    content += sections.introduction || "Background on " + query + "\n\n";

    content += "---\n\n## Methods\n\n";
    content += "Systematic literature search of PubMed database.\n\n";

    content += "---\n\n## Results\n\n";
    content += "A total of " + articles.length + " relevant publications were identified.\n\n";

    for (var i = 0; i < Math.min(articles.length, 10); i++) {
      var a = articles[i];
      content += "### " + (i+1) + ". " + (a.title || "Untitled") + "\n\n";
      if (a.abstract) {
        content += a.abstract.substring(0, 800) + "...\n\n";
      }
    }

    content += "---\n\n## Discussion\n\n";
    content += sections.discussion || "Analysis of findings...\n\n";

    content += "---\n\n## Conclusions\n\n";
    content += "This review synthesizes the current evidence on " + query + ".\n\n";

    content += "---\n\n*Generated by MA Research Assistant*\n";

    fs.writeFileSync(filepath, content, "utf8");
    return filepath;
  }

  /**
   * Generate PowerPoint slides
   */
  async generateSlides(query, articles, summary) {
    var PptxGenJS;
    try {
      PptxGenJS = require("pptxgenjs");
    } catch (e) {
      console.log("PPTXGenJS not installed, generating text-based slides instead");
      return this.generateSlidesText(query, articles, summary);
    }

    var timestamp = new Date().toISOString().replace(/[:.]/g, "-").substring(0, 19);
    var filename = "MA-Slides-" + this.slugify(query) + "-" + timestamp + ".pptx";
    var filepath = path.join(this.outputDir, filename);

    var pres = new PptxGenJS();
    pres.layout = "LAYOUT_16x9";
    pres.title = query;
    pres.author = "MA Research Assistant";

    // Title slide
    var slide1 = pres.addSlide();
    slide1.addText(query, { x: 0.5, y: 2, w: "90%", h: 1.5, fontSize: 32, bold: true });
    slide1.addText("Medical Affairs Research Summary", { x: 0.5, y: 4, w: "90%", h: 0.5, fontSize: 18 });
    slide1.addText(new Date().toISOString().substring(0, 10), { x: 0.5, y: 5, w: "90%", h: 0.3, fontSize: 14 });

    // Summary slide
    var slide2 = pres.addSlide();
    slide2.addText("Executive Summary", { x: 0.5, y: 0.3, w: "90%", h: 0.5, fontSize: 24, bold: true });
    var summaryText = summary ? summary.substring(0, 1500) : "No summary available";
    slide2.addText(summaryText, { x: 0.5, y: 1, w: "90%", h: 4, fontSize: 14 });

    // Key publications slides
    for (var i = 0; i < Math.min(articles.length, 8); i++) {
      var a = articles[i];
      var slide = pres.addSlide();
      slide.addText("Key Publication " + (i+1), { x: 0.5, y: 0.3, w: "90%", h: 0.4, fontSize: 20, bold: true });
      slide.addText(a.title || "Untitled", { x: 0.5, y: 0.8, w: "90%", h: 1, fontSize: 16, bold: true });
      slide.addText("PMID: " + a.pmid, { x: 0.5, y: 1.9, w: "90%", h: 0.3, fontSize: 12 });
      if (a.journal) {
        slide.addText(a.journal, { x: 0.5, y: 2.2, w: "90%", h: 0.3, fontSize: 12 });
      }
      if (a.abstract) {
        var abstractText = a.abstract.substring(0, 600) + "...";
        slide.addText(abstractText, { x: 0.5, y: 2.7, w: "90%", h: 2.5, fontSize: 11 });
      }
    }

    // Save
    pres.writeFile({ fileName: filepath });
    return filepath;
  }

  /**
   * Text-based slides fallback
   */
  async generateSlidesText(query, articles, summary) {
    var filename = this.getFilename("MA-Slides-" + this.slugify(query), "txt");
    var filepath = path.join(this.outputDir, filename);

    var content = "MEDICAL AFFAIRS RESEARCH SLIDES\n";
    content += "============================\n\n";
    content += "Topic: " + query + "\n";
    content += "Date: " + new Date().toISOString().substring(0, 10) + "\n\n";

    content += "EXECUTIVE SUMMARY\n";
    content += "-----------------\n";
    content += (summary || "N/A") + "\n\n";

    content += "KEY PUBLICATIONS\n";
    content += "----------------\n";
    for (var i = 0; i < Math.min(articles.length, 10); i++) {
      content += "\n" + (i+1) + ". " + articles[i].title + "\n";
      content += "   PMID: " + articles[i].pmid + "\n";
    }

    fs.writeFileSync(filepath, content, "utf8");
    return filepath;
  }

  /**
   * Generate KOL briefing document
   */
  async generateKOLBriefing(query, articles, briefing) {
    var filename = this.getFilename("KOL-Briefing-" + this.slugify(query), "md");
    var filepath = path.join(this.outputDir, filename);

    var content = "# KOL Briefing Document\n\n";
    content += "**Topic:** " + query + "\n";
    content += "**Date:** " + new Date().toISOString().substring(0, 10) + "\n\n";

    content += "---\n\n";
    content += briefing || "KOL briefing content...\n\n";

    content += "---\n\n## Key Supporting Literature\n\n";
    for (var i = 0; i < articles.length; i++) {
      content += "- " + articles[i].title + " (PMID: " + articles[i].pmid + ")\n";
    }

    fs.writeFileSync(filepath, content, "utf8");
    return filepath;
  }

  /**
   * Generate medical information response
   */
  async generateMedicalInfoResponse(query, articles, response) {
    var filename = this.getFilename("MI-Response-" + this.slugify(query), "md");
    var filepath = path.join(this.outputDir, filename);

    var content = "# Medical Information Response\n\n";
    content += "**Inquiry:** " + query + "\n";
    content += "**Date:** " + new Date().toISOString().substring(0, 10) + "\n\n";

    content += "---\n\n";
    content += response + "\n\n";

    content += "---\n\n## References\n\n";
    for (var i = 0; i < articles.length; i++) {
      content += (i+1) + ". PMID " + articles[i].pmid + ": " + articles[i].title + "\n";
    }

    fs.writeFileSync(filepath, content, "utf8");
    return filepath;
  }

  /**
   * Helper: slugify for filenames
   */
  slugify(text) {
    return text.toLowerCase()
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/(^-|-$)/g, "")
      .substring(0, 50);
  }
}

module.exports = OutputGenerator;